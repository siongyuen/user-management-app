<div class="container-fluid">
  <!-- Notification Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div *ngFor="let notification of notifications" 
         class="toast show" 
         [class.bg-success]="notification.type === 'success'"
         [class.bg-danger]="notification.type === 'error'"
         [class.text-white]="true"
         role="alert" 
         aria-live="assertive" 
         aria-atomic="true">
      <div class="toast-header" 
           [class.bg-success]="notification.type === 'success'"
           [class.bg-danger]="notification.type === 'error'"
           [class.text-white]="true">
        <i class="fas me-2" 
           [class.fa-check-circle]="notification.type === 'success'"
           [class.fa-exclamation-circle]="notification.type === 'error'"></i>
        <strong class="me-auto">
          {{ notification.type === 'success' ? 'Success' : 'Error' }}
        </strong>
        <button type="button" 
                class="btn-close btn-close-white" 
                (click)="removeNotification(notification.id)"
                aria-label="Close"></button>
      </div>
      <div class="toast-body">
        {{ notification.message }}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
              <i class="fas fa-users me-2"></i>
              User Access
            </h2>
            <div class="d-flex gap-2">
              <button 
                class="btn btn-success"
                (click)="openCreateModal()">
                <i class="fas fa-plus me-1"></i>
                Create User
              </button>
              <button 
                class="btn btn-danger"
                (click)="deleteSelectedUsers()"
                [disabled]="selectedUsers.size === 0">
                <i class="fas fa-trash me-1"></i>
                Delete Selected ({{ selectedUsers.size }})
              </button>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Select All / Deselect All -->
          <div class="mb-3">
            <div class="form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="selectAll"
                [checked]="allSelected"
                [indeterminate]="selectedUsers.size > 0 && selectedUsers.size < users.length"
                (change)="toggleSelectAll()">
              <label class="form-check-label fw-bold" for="selectAll">
                {{ allSelected ? 'Deselect All' : 'Select All' }} 
                ({{ users.length }} users total, {{ paginatedUsers.length }} on this page)
              </label>
            </div>
          </div>

          <!-- Users Table -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th width="50">
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [checked]="allSelected"
                      [indeterminate]="selectedUsers.size > 0 && selectedUsers.size < users.length"
                      (change)="toggleSelectAll()">
                  </th>
                  <th>User</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Group</th>
                  <th>Join Date</th>
                  <th>Last Login</th>
                  <th width="150">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of paginatedUsers" [class.table-active]="isUserSelected(user.id)">
                  <td>
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [checked]="isUserSelected(user.id)"
                      (change)="toggleSelectUser(user.id)">
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <img 
                        [src]="user.avatar" 
                        [alt]="user.name" 
                        class="rounded-circle me-2"
                        width="40" 
                        height="40">
                      <div>
                        <div class="fw-bold">{{ user.name }}</div>
                        <small class="text-muted">ID: {{ user.id }}</small>
                      </div>
                    </div>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge" [class]="getStatusBadgeClass(user.status)">
                      <i class="fas" [class.fa-check-circle]="user.status === 'active'" 
                         [class.fa-times-circle]="user.status === 'inactive'"></i>
                      {{ user.status | titlecase }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex flex-wrap gap-1">
                      <span *ngFor="let group of user.groups" class="badge bg-info text-dark">
                        {{ group }}
                      </span>
                      <span *ngIf="user.groups.length === 0" class="text-muted fst-italic">No groups</span>
                    </div>
                  </td>
                  <td>{{ user.joinDate | date:'MMM dd, yyyy' }}</td>
                  <td>{{ user.lastLogin | date:'MMM dd, yyyy HH:mm' }}</td>
                  <td>
                    <div class="dropdown">
                      <button 
                        class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                        type="button" 
                        [id]="'actionMenu' + user.id"
                        data-bs-toggle="dropdown" 
                        aria-expanded="false">
                        <i class="fas fa-cog"></i>
                      </button>
                      <ul class="dropdown-menu" [attr.aria-labelledby]="'actionMenu' + user.id">
                        <!-- Status Actions -->
                        <li>
                          <h6 class="dropdown-header">Status Actions</h6>
                        </li>
                        <li *ngIf="user.status === 'inactive'">
                          <a class="dropdown-item" href="#" (click)="activateUser(user.id); $event.preventDefault()">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Activate
                          </a>
                        </li>
                        <li *ngIf="user.status === 'active'">
                          <a class="dropdown-item" href="#" (click)="deactivateUser(user.id); $event.preventDefault()">
                            <i class="fas fa-times-circle text-warning me-2"></i>
                            Deactivate
                          </a>
                        </li>
                        
                        <!-- Group Assignment -->
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <h6 class="dropdown-header">Assign to Group</h6>
                        </li>
                        <li *ngFor="let group of groups">
                          <a class="dropdown-item" 
                             href="#" 
                             (click)="toggleUserGroup(user, group.name); $event.preventDefault()"
                             [class.active]="isUserInGroup(user, group.name)">
                            <i class="fas fa-users me-2" 
                               [class.text-primary]="isUserInGroup(user, group.name)"></i>
                            {{ group.name }}
                            <i *ngIf="isUserInGroup(user, group.name)" class="fas fa-check text-primary ms-auto"></i>
                          </a>
                        </li>
                        
                        <!-- Delete Action -->
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <a class="dropdown-item text-danger" href="#" (click)="deleteUser(user.id); $event.preventDefault()">
                            <i class="fas fa-trash me-2"></i>
                            Delete User
                          </a>
                        </li>
                      </ul>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <nav aria-label="User pagination" *ngIf="totalPages > 1" class="mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted">
                Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
                {{ min(currentPage * itemsPerPage, users.length) }} of 
                {{ users.length }} users
              </div>
              <ul class="pagination mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <a class="page-link" href="#" (click)="goToFirstPage(); $event.preventDefault()" 
                     [attr.aria-disabled]="currentPage === 1">
                    <i class="fas fa-angle-double-left"></i>
                  </a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <a class="page-link" href="#" (click)="goToPreviousPage(); $event.preventDefault()" 
                     [attr.aria-disabled]="currentPage === 1">
                    <i class="fas fa-angle-left"></i>
                  </a>
                </li>
                <li *ngFor="let pageNum of getPageNumbers()" 
                    class="page-item" 
                    [class.active]="pageNum === currentPage">
                  <a class="page-link" href="#" 
                     (click)="goToPage(pageNum); $event.preventDefault()">
                    {{ pageNum }}
                  </a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <a class="page-link" href="#" (click)="goToNextPage(); $event.preventDefault()" 
                     [attr.aria-disabled]="currentPage === totalPages">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <a class="page-link" href="#" (click)="goToLastPage(); $event.preventDefault()" 
                     [attr.aria-disabled]="currentPage === totalPages">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
              </ul>
            </div>
          </nav>

          <!-- Empty State -->
          <div *ngIf="users.length === 0" class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Users Found</h4>
            <p class="text-muted">Get started by creating your first user.</p>
            <button class="btn btn-primary" (click)="openCreateModal()">
              <i class="fas fa-plus me-1"></i>
              Create First User
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" 
     tabindex="-1" aria-labelledby="createUserModalLabel" [attr.aria-hidden]="!showCreateModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createUserModalLabel">
          <i class="fas fa-user-plus me-2"></i>
          Create New User
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createUser()" #createForm="ngForm">
          <div class="mb-3">
            <label for="userName" class="form-label">Name *</label>
            <input 
              type="text" 
              class="form-control" 
              id="userName"
              [(ngModel)]="newUser.name"
              name="name"
              required>
          </div>
          
          <div class="mb-3">
            <label for="userEmail" class="form-label">Email *</label>
            <input 
              type="email" 
              class="form-control" 
              id="userEmail"
              [(ngModel)]="newUser.email"
              name="email"
              required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Groups</label>
            <div class="form-check-group">
              <div *ngFor="let group of groups" class="form-check">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [id]="'group-' + group.id"
                  [value]="group.name"
                  [checked]="newUser.groups.includes(group.name)"
                  (change)="toggleNewUserGroup(group.name, $event)">
                <label class="form-check-label" [for]="'group-' + group.id">
                  {{ group.name }}
                </label>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="userStatus" class="form-label">Status</label>
            <select 
              class="form-select" 
              id="userStatus"
              [(ngModel)]="newUser.status"
              name="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
          Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="createUser()">
          <i class="fas fa-save me-1"></i>
          Create User
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div *ngIf="showCreateModal" class="modal-backdrop fade show"></div>